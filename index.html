<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Electrician Tools</title>
  <style>
    :root{ --fg:#0f0; --bg:#000; --line:#0f0; --box-h:1.8em; --hit-bg:#00ff6a; --hit-fg:#000; }
    body { margin:0; padding:0; font-family:monospace; background:var(--bg); color:var(--fg); }
    nav { background:var(--bg); border-bottom:1px solid var(--line); display:flex; gap:1rem; padding:.5rem; }
    nav button { background:transparent; border:1px solid var(--line); color:var(--fg); padding:.25rem .5rem; cursor:pointer; }
    nav button.active { background:var(--fg); color:#000; }
    .section { display:none; padding:1rem; }
    .section.active { display:block; }
    input, select, textarea, button { background:#000; color:#0f0; border:1px solid #0f0; font-family:monospace; padding:.25rem; height:var(--box-h); box-sizing:border-box; font-size:0.8rem; }
    h1, summary { color:#0f0; }
    details { border:1px solid #0f0; padding:.5rem; margin-top:1rem; }
    .label-small { font-size:0.7rem; color:#0f0; margin-bottom:0.1rem; display:block; text-align:left; }

    .inputs-row, .results-row { display:flex; gap:0.5rem; align-items:flex-start; margin-bottom:0.3rem; }
    .inputs-row > div, .results-row > div { display:flex; flex-direction:column; align-items:flex-start; }
    .temp-input { width:6ch; text-align:left; -moz-appearance:textfield; padding-right:1.2em; }
    .temp-input::-webkit-outer-spin-button,
    .temp-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .temp-wrapper { position:relative; display:inline-block; }
    .temp-wrapper::after { content:"°C"; position:absolute; right:4px; top:50%; transform:translateY(-50%); color:#0f0; font-size:0.8rem; pointer-events:none; }

    .result-box { border:1px solid #0f0; background:#000; padding:0 .5rem; min-width:6ch; text-align:left; font-family:monospace; color:#0f0; height:var(--box-h); display:flex; align-items:center; box-sizing:border-box; font-size:0.8rem; }

    /* Drag bars */
    .r1-bar{ position:relative; width:200px; height:1.6em; border:1px solid #0f0; background:#000; user-select:none; display:flex; align-items:center; touch-action:none; cursor:ew-resize; }
    .r1-fill{ position:absolute; left:0; top:0; bottom:0; width:0%; background:#00ff6a; }
    .r1-text{ position:absolute; left:8px; font:700 0.8rem monospace; color:#0f0; pointer-events:none; z-index:2; transition:color .15s; }

    /* === Max Zs (matrix) styles === */
    .controls{padding:10px 16px;display:flex;flex-direction:column;gap:6px}
    .control{display:flex;flex-direction:column;gap:2px}
    .wrap{padding:10px 16px;display:flex;flex-direction:column;align-items:flex-start}
    .matrix-wrap{width:200px}
    table{width:100%;border-collapse:collapse;background:#000;color:var(--fg);font-variant-numeric:tabular-nums;font-size:12px;table-layout:fixed}
    th,td{border:1px solid #0f0;padding:2px;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    thead th{background:#000;color:var(--fg)}
    tbody th{background:#000;color:var(--fg);text-align:left;padding-left:2px;width:35px}
    .hit{background:#00ff6a;color:#000!important}
  </style>
</head>
<body>
  <nav>
    <button id="tabRing" class="active" data-tab="ring">Ring Continuity</button>
    <button id="tabZs" data-tab="zs">Max Zs</button>
  </nav>

  <!-- ===== RING TAB ===== -->
  <div id="ring" class="section active">
    <h1 id="ringTitle">Ring Continuity Checker</h1>
    <div class="inputs-row">
      <div>
        <label class="label-small" for="lineCSA">LINE</label>
        <select id="lineCSA"><option>2.5</option><option>4.0</option><option>6.0</option></select>
      </div>
      <div>
        <label class="label-small" for="cpcCSA">CPC</label>
        <select id="cpcCSA"><option>1.0</option><option>1.5</option><option>2.5</option></select>
      </div>
      <div>
        <label class="label-small" for="temp">TEMP</label>
        <div class="temp-wrapper">
          <input type="number" id="temp" class="temp-input" value="30" />
        </div>
      </div>
    </div>

    <div class="results-row">
      <div>
        <label class="label-small">r2</label>
        <div id="r2" class="result-box">0 Ω</div>
      </div>
      <div>
        <label class="label-small">R1+R2</label>
        <div id="r1r2" class="result-box">0.00 Ω</div>
      </div>
      <div>
        <label class="label-small">Length</label>
        <div id="cableLength" class="result-box">0 m</div>
      </div>
    </div>

    <div class="results-row">
      <div>
        <label class="label-small">r1</label>
        <div id="r1Bar" class="r1-bar" aria-label="r1 slider" role="slider" aria-valuemin="0" aria-valuemax="2.00" aria-valuenow="0.00">
          <div id="r1Fill" class="r1-fill"></div>
          <div id="r1Text" class="r1-text">0.00 Ω</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MAX Zs TAB ===== -->
  <div id="zs" class="section">
    <div style="padding:10px 16px">
      <h1>MAX Zs</h1>
      <h2 style="margin:0 0 6px 0;font-size:12px;color:var(--fg);font-weight:normal">Device BS EN 60898 / 61009</h2>
    </div>
    <div class="controls">
      <div class="control" id="typeCtrl">
        <div class="r1-bar" id="typeBar"><div class="r1-fill" id="typeFill"></div><div class="r1-text" id="typeText">B</div></div>
      </div>
      <div class="control" id="ampCtrl">
        <div class="r1-bar" id="ampBar"><div class="r1-fill" id="ampFill"></div><div class="r1-text" id="ampText">32A</div></div>
      </div>
      <div class="control" id="pctCtrl">
        <div class="r1-bar" id="pctBar"><div class="r1-fill" id="pctFill"></div><div class="r1-text" id="pctText">80%</div></div>
      </div>
    </div>
    <div class="wrap">
      <div class="matrix-wrap">
        <table id="matrix"></table>
      </div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const store = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k, d) => { try { const v = JSON.parse(localStorage.getItem(k)); return v ?? d; } catch { return d; } };

    // ===== Tabs =====
    const lastTab = load('tab','ring');
    function showTab(id){
      $$('#ring,#zs').forEach(x=>x.classList.remove('active'));
      $$('#tabRing,#tabZs').forEach(x=>x.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[data-tab="${id}"]`).classList.add('active');
      store('tab',id);
    }
    $('#tabRing').onclick=()=>showTab('ring');
    $('#tabZs').onclick=()=>showTab('zs');
    showTab(lastTab);

    // ===== Ring calc =====
    const R_PER_M_20C = { 1.0:0.0181, 1.5:0.0121, 2.5:0.00741, 4.0:0.00461, 6.0:0.00308 };
    const ALPHA = 0.00393; // copper temp coeff
    const maxR1 = 2.00;

    const lineCSA = $('#lineCSA');
    const cpcCSA  = $('#cpcCSA');
    const temp    = $('#temp');
    const r2Out = $('#r2');
    const r1r2Out = $('#r1r2');
    const lenOut = $('#cableLength');

    const r1Bar = $('#r1Bar');
    const r1Fill = $('#r1Fill');
    const r1Text = $('#r1Text');

    let r1 = load('ring.r1', 0);

    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

    function setR1(val){
      r1 = clamp(val, 0, maxR1);
      const pct = (r1 / maxR1) * 100;
      r1Fill.style.width = pct.toFixed(2) + '%';
      r1Text.textContent = r1.toFixed(2) + ' Ω';
      // Colour swap using only the number width (ignore Ω)
      const digitsWidth = r1Text.textContent.split(' ')[0].length * 8; // ≈8px/char mono
      const firstDigitRight = r1Text.offsetLeft + digitsWidth;
      const fillWidth = r1Fill.offsetWidth;
      r1Text.style.color = (fillWidth < firstDigitRight) ? '#0f0' : '#000';
      r1Bar.setAttribute('aria-valuenow', r1.toFixed(2));
      store('ring.r1', r1);
      updateRing();
    }

    // Smooth, mobile-friendly dragging for R1
    let dragging=false, r1Rect=null, lastX=0, rafPending=false;
    function posToR1(clientX){
      const rect = r1Rect || r1Bar.getBoundingClientRect();
      const x = clamp(clientX - rect.left, 0, rect.width);
      return (x / rect.width) * maxR1;
    }
    r1Bar.addEventListener('pointerdown', (e)=>{
      e.preventDefault(); dragging=true; r1Rect=r1Bar.getBoundingClientRect(); lastX=e.clientX;
      r1Bar.setPointerCapture(e.pointerId); setR1(posToR1(lastX));
    }, {passive:false});
    r1Bar.addEventListener('pointermove', (e)=>{
      if(!dragging) return; e.preventDefault(); lastX=e.clientX;
      if(!rafPending){ rafPending=true; requestAnimationFrame(()=>{ setR1(posToR1(lastX)); rafPending=false; }); }
    }, {passive:false});
    function endR1(e){ dragging=false; r1Rect=null; try{ r1Bar.releasePointerCapture(e.pointerId); }catch{} }
    r1Bar.addEventListener('pointerup', endR1); r1Bar.addEventListener('pointercancel', endR1); r1Bar.addEventListener('pointerleave', (e)=>{ if(dragging) endR1(e); });

    function updateRing(){
      const L = parseFloat(lineCSA.value);
      const E = parseFloat(cpcCSA.value);
      const T = parseFloat(temp.value) || 30;
      const ohmPerM = R_PER_M_20C[L];
      if(!ohmPerM || !R_PER_M_20C[E]){ r2Out.textContent='--'; r1r2Out.textContent='--'; lenOut.textContent='--'; return; }
      const r2 = r1 * (L / E);
      const r1r2 = (r1 + r2) / 4;
      const corr = 1 + ALPHA * (T - 20);
      const r1_20 = r1 / corr; // adjust to 20°C
      const halfLen = r1_20 / ohmPerM; // per leg length
      r2Out.textContent = r2.toFixed(2) + ' Ω';
      r1r2Out.textContent = r1r2.toFixed(2) + ' Ω';
      lenOut.textContent = Math.round(halfLen) + ' m';
      store('ring.lineCSA', L); store('ring.cpcCSA', E); store('ring.temp', T);
    }

    // init ring
    lineCSA.value = load('ring.lineCSA', '2.5');
    cpcCSA.value  = load('ring.cpcCSA',  '1.0');
    temp.value    = load('ring.temp', 30);
    setR1(load('ring.r1', 0));
    lineCSA.addEventListener('change', updateRing);
    cpcCSA.addEventListener('change', updateRing);
    temp.addEventListener('input', updateRing);

    // ===== Max Zs matrix =====
    const RATINGS=[6,10,16,20,25,32,40,50,63];
    const TYPES=['B','C','D'];
    const DATA_100={
      B:{6:7.28,10:4.37,16:2.73,20:2.19,25:1.75,32:1.37,40:1.09,50:0.87,63:0.69},
      C:{6:3.64,10:2.19,16:1.37,20:1.09,25:0.87,32:0.68,40:0.55,50:0.44,63:0.35},
      D:{6:1.82,10:1.09,16:0.68,20:0.55,25:0.44,32:0.34,40:0.27,50:0.22,63:0.17}
    };

    let selType='B', selAmp=32, pct=80; // pct 80 or 100

    const els={
      matrix:document.getElementById('matrix'),
      typeBar:document.getElementById('typeBar'), typeFill:document.getElementById('typeFill'), typeText:document.getElementById('typeText'),
      ampBar:document.getElementById('ampBar'), ampFill:document.getElementById('ampFill'), ampText:document.getElementById('ampText'),
      pctBar:document.getElementById('pctBar'), pctFill:document.getElementById('pctFill'), pctText:document.getElementById('pctText')
    };

    function fmt(x){return (Math.round(x*100)/100).toFixed(2).replace(/\.00$/,'');}

    function buildTable(){
      let html='<thead><tr><th>A</th>'+TYPES.map(T=>`<th>${T}</th>`).join('')+'</tr></thead>';
      html+='<tbody>';
      RATINGS.forEach(A=>{
        html+=`<tr><th>${A}</th>`;
        TYPES.forEach(T=>{
          const v=DATA_100[T][A]*(pct/100);
          html+=`<td data-type="${T}" data-amp="${A}">${fmt(v)}</td>`;
        });
        html+='</tr>';
      });
      html+='</tbody>';
      els.matrix.innerHTML=html;
      highlight();
    }

    function highlight(){
      els.matrix.querySelectorAll('td').forEach(td=>td.classList.remove('hit'));
      const cell=els.matrix.querySelector(`td[data-type="${selType}"][data-amp="${selAmp}"]`);
      if(cell) cell.classList.add('hit');
    }

    function setTextColor(textEl, fillEl){
      const fillWidth=parseFloat(fillEl.style.width)||0;
      textEl.style.color = (fillWidth<=0) ? '#00ff6a' : '#000';
    }

    // Generic drag for the three Max Zs bars
    function attachDrag(bar,fill,text,cb){
      function setFromX(x){
        const r=bar.getBoundingClientRect();
        let p=(x-r.left)/r.width; p=Math.max(0,Math.min(1,p));
        cb(p);
        setTextColor(text,fill);
      }
      function start(e){
        e.preventDefault();
        const move=(ev)=>{ const pt=ev.touches?ev.touches[0]:ev; setFromX(pt.clientX); };
        const end=()=>{ document.removeEventListener('mousemove',move); document.removeEventListener('touchmove',move); document.removeEventListener('mouseup',end); document.removeEventListener('touchend',end); };
        document.addEventListener('mousemove',move,{passive:false});
        document.addEventListener('touchmove',move,{passive:false});
        document.addEventListener('mouseup',end);
        document.addEventListener('touchend',end);
      }
      bar.addEventListener('mousedown',start,{passive:false});
      bar.addEventListener('touchstart',start,{passive:false});
    }

    // TYPE slider
    (function(){
      const values=TYPES;
      attachDrag(els.typeBar,els.typeFill,els.typeText,(p)=>{
        const idx=Math.round(p*(values.length-1));
        selType=values[idx];
        els.typeFill.style.width=(idx/(values.length-1))*100+'%';
        els.typeText.textContent=selType;
        buildTable();
      });
    })();

    // AMP slider
    (function(){
      const values=RATINGS;
      attachDrag(els.ampBar,els.ampFill,els.ampText,(p)=>{
        const idx=Math.round(p*(values.length-1));
        selAmp=values[idx];
        els.ampFill.style.width=(idx/(values.length-1))*100+'%';
        els.ampText.textContent=selAmp+'A';
        highlight();
      });
    })();

    // PERCENT slider (binary 80/100)
    (function(){
      attachDrag(els.pctBar,els.pctFill,els.pctText,(p)=>{
        const val=(p<0.5)?80:100; pct=val;
        els.pctFill.style.width=(val===80?0:100)+'%';
        els.pctText.textContent=val+'%';
        buildTable();
      });
    })();

    // Init Max Zs
    (function initZs(){
      els.typeFill.style.width='0%';
      els.ampFill.style.width=(RATINGS.indexOf(32)/(RATINGS.length-1))*100+'%';
      els.pctFill.style.width='0%'; // start at 80%
      els.typeText.textContent='B';
      els.ampText.textContent='32A';
      els.pctText.textContent='80%';
      setTextColor(els.typeText,els.typeFill);
      setTextColor(els.ampText,els.ampFill);
      setTextColor(els.pctText,els.pctFill);
      buildTable();
    })();

    // First render ring values
    updateRing();
  </script>
</body>
</html>
