<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Electrician Tools</title>
  <style>
    :root{ --fg:#0f0; --bg:#000; --line:#0f0; --box-h:1.8em; }
    body { margin:0; padding:0; font-family:monospace; background:var(--bg); color:var(--fg); overscroll-behavior:none; }
    nav { background:var(--bg); border-bottom:1px solid var(--line); display:flex; gap:1rem; padding:.5rem; }
    nav button { background:transparent; border:1px solid var(--line); color:var(--fg); padding:.25rem .5rem; cursor:pointer; }
    nav button.active { background:var(--fg); color:#000; }
    .section { display:none; padding:1rem; }
    .section.active { display:block; }
    input, select, textarea, button { background:#000; color:#0f0; border:1px solid #0f0; font-family:monospace; padding:.25rem; height:var(--box-h); box-sizing:border-box; font-size:0.8rem; }
    h1, summary { color:#0f0; }
    details { border:1px solid #0f0; padding:.5rem; margin-top:1rem; }
    .label-small { font-size:0.7rem; color:#0f0; margin-bottom:0.1rem; display:block; text-align:left; }

    .inputs-row, .results-row { display:flex; gap:0.5rem; align-items:flex-start; margin-bottom:0.3rem; }
    .inputs-row > div, .results-row > div { display:flex; flex-direction:column; align-items:flex-start; }
    .temp-input { width:6ch; text-align:left; -moz-appearance:textfield; padding-right:1.2em; }
    .temp-input::-webkit-outer-spin-button,
    .temp-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .temp-wrapper { position:relative; display:inline-block; }
    .temp-wrapper::after { content:"°C"; position:absolute; right:4px; top:50%; transform:translateY(-50%); color:#0f0; font-size:0.8rem; pointer-events:none; }

    .result-box { border:1px solid #0f0; background:#000; padding:0 .5rem; min-width:6ch; text-align:left; font-family:monospace; color:#0f0; height:var(--box-h); display:flex; align-items:center; box-sizing:border-box; font-size:0.8rem; }

    .r1-bar{ position:relative; width:320px; height:var(--box-h); border:1px solid #0f0; background:#000; user-select:none; display:flex; align-items:center; touch-action:none; -ms-touch-action:none; cursor:ew-resize; }
    .r1-fill{ position:absolute; left:0; top:0; bottom:0; width:0%; background:#00ff6a; }
    .r1-text{ position:absolute; left:8px; font-weight:700; color:#000; pointer-events:none; z-index:2; font-size:0.8rem; transition:color 0.2s; }
  </style>
</head>
<body>
  <nav>
    <button id="tabRing" class="active" data-tab="ring">Ring Continuity</button>
    <button id="tabZs" data-tab="zs">Max Zs</button>
  </nav>

  <div id="ring" class="section active">
    <h1 id="ringTitle">Ring Continuity Checker</h1>
    <div class="inputs-row">
      <div>
        <label class="label-small" for="lineCSA">LINE</label>
        <select id="lineCSA"><option>2.5</option><option>4.0</option><option>6.0</option></select>
      </div>
      <div>
        <label class="label-small" for="cpcCSA">CPC</label>
        <select id="cpcCSA"><option>1.0</option><option>1.5</option><option>2.5</option></select>
      </div>
      <div>
        <label class="label-small" for="temp">TEMP</label>
        <div class="temp-wrapper">
          <input type="number" id="temp" class="temp-input" value="30" />
        </div>
      </div>
    </div>

    <div class="results-row">
      <div>
        <label class="label-small">r2</label>
        <div id="r2" class="result-box">0 Ω</div>
      </div>
      <div>
        <label class="label-small">R1+R2</label>
        <div id="r1r2" class="result-box">0.00 Ω</div>
      </div>
      <div>
        <label class="label-small">Length</label>
        <div id="cableLength" class="result-box">0 m</div>
      </div>
    </div>

    <div class="results-row">
      <div>
        <label class="label-small">r1</label>
        <div id="r1Bar" class="r1-bar" aria-label="r1 slider" role="slider" aria-valuemin="0" aria-valuemax="2.00" aria-valuenow="0.00">
          <div id="r1Fill" class="r1-fill"></div>
          <div id="r1Text" class="r1-text">0.00 Ω</div>
        </div>
      </div>
    </div>
  </div>

  <div id="zs" class="section">
    <h1>Max Zs (80%)</h1>
    <select id="mcbType"><option>B</option><option>C</option><option>D</option></select>
    <select id="mcbAmps"><option>6</option><option>10</option><option>16</option><option>20</option><option>25</option><option>32</option><option>40</option><option>45</option></select>
    <div class="result">Zs: <span id="zsResult">-- Ω</span></div>
    <label><input id="eightyToggle" type="checkbox" checked /> 80% factor</label>
    <details>
      <summary>Show/Edit table</summary>
      <textarea id="zsJSON"></textarea>
      <button id="saveZs">Save</button>
      <button id="resetZs">Reset</button>
    </details>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const store = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k, d) => { try { const v = JSON.parse(localStorage.getItem(k)); return v ?? d; } catch { return d; } };

    const lastTab = load('tab','ring');
    function showTab(id){
      $$('#ring,#zs').forEach(x=>x.classList.remove('active'));
      $$('#tabRing,#tabZs').forEach(x=>x.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[data-tab="${id}"]`).classList.add('active');
      store('tab',id);
    }
    $('#tabRing').onclick=()=>showTab('ring');
    $('#tabZs').onclick=()=>showTab('zs');
    showTab(lastTab);

    const R_PER_M_20C = { 1.0:0.0181, 1.5:0.0121, 2.5:0.00741, 4.0:0.00461, 6.0:0.00308 };
    const ALPHA = 0.00393;
    const maxR1 = 2.00;

    const lineCSA = $('#lineCSA');
    const cpcCSA  = $('#cpcCSA');
    const temp    = $('#temp');
    const r2Out = $('#r2');
    const r1r2Out = $('#r1r2');
    const lenOut = $('#cableLength');

    const r1Bar = $('#r1Bar');
    const r1Fill = $('#r1Fill');
    const r1Text = $('#r1Text');

    let r1 = load('ring.r1', 0);
    let dragging = false;
    let r1Rect = null; // cached bounds during drag
    let lastClientX = 0;
    let rafPending = false;

    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

    function setR1(val){
      r1 = clamp(val, 0, maxR1);
      const pct = (r1 / maxR1) * 100;
      r1Fill.style.width = pct.toFixed(2) + '%';
      r1Text.textContent = r1.toFixed(2) + ' Ω';

      // Measure only the number width, ignore the trailing unit symbol
      const digitsWidth = r1Text.textContent.split(' ')[0].length * 8; // approx 8px per char
      const textPos = r1Text.offsetLeft + digitsWidth;
      const fillWidth = r1Fill.offsetWidth;

      if(fillWidth < textPos){
        r1Text.style.color = '#0f0';
      } else {
        r1Text.style.color = '#000';
      }

      r1Bar.setAttribute('aria-valuenow', r1.toFixed(2));
      store('ring.r1', r1);
      updateRing();
    }

    function posToR1(clientX){
      const rect = r1Rect || r1Bar.getBoundingClientRect();
      const x = clamp(clientX - rect.left, 0, rect.width);
      const ratio = x / rect.width;
      return ratio * maxR1;
    }

    r1Bar.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      dragging = true;
      r1Rect = r1Bar.getBoundingClientRect();
      lastClientX = e.clientX;
      r1Bar.setPointerCapture(e.pointerId);
      setR1(posToR1(lastClientX));
    }, {passive:false});

    function onPointerMove(e){
      if(!dragging) return;
      e.preventDefault();
      lastClientX = e.clientX;
      if(!rafPending){
        rafPending = true;
        requestAnimationFrame(()=>{ setR1(posToR1(lastClientX)); rafPending = false; });
      }
    }
    r1Bar.addEventListener('pointermove', onPointerMove, {passive:false});

    function endPointer(e){
      dragging = false;
      r1Rect = null;
      try{ r1Bar.releasePointerCapture(e.pointerId); }catch{}
    }
    r1Bar.addEventListener('pointerup', endPointer);
    r1Bar.addEventListener('pointercancel', endPointer);
    r1Bar.addEventListener('pointerleave', (e)=>{ if(dragging) endPointer(e); });

    // Touch fallback so you can drag from anywhere inside the box on older mobiles
    r1Bar.addEventListener('touchstart', (e)=>{
      if(e.changedTouches && e.changedTouches[0]){
        e.preventDefault();
        dragging = true;
        r1Rect = r1Bar.getBoundingClientRect();
        lastClientX = e.changedTouches[0].clientX;
        setR1(posToR1(lastClientX));
      }
    }, {passive:false});
    r1Bar.addEventListener('touchmove', (e)=>{
      if(!dragging) return;
      if(e.changedTouches && e.changedTouches[0]){
        e.preventDefault();
        lastClientX = e.changedTouches[0].clientX;
        if(!rafPending){
          rafPending = true;
          requestAnimationFrame(()=>{ setR1(posToR1(lastClientX)); rafPending = false; });
        }
      }
    }, {passive:false});
    r1Bar.addEventListener('touchend', ()=>{ dragging=false; r1Rect=null; });
    r1Bar.addEventListener('touchcancel', ()=>{ dragging=false; r1Rect=null; });

    window.addEventListener('resize', ()=>{ if(r1Rect) r1Rect = r1Bar.getBoundingClientRect(); });

    function updateRing(){
      const L = parseFloat(lineCSA.value);
      const E = parseFloat(cpcCSA.value);
      const T = parseFloat(temp.value) || 30;
      const ohmPerM = R_PER_M_20C[L];
      if(!ohmPerM || !R_PER_M_20C[E]){ r2Out.textContent='--'; r1r2Out.textContent='--'; lenOut.textContent='--'; return; }

      const r2 = r1 * (L / E);
      const r1r2 = (r1 + r2) / 4;
      const corr = 1 + ALPHA * (T - 20);
      const r1_20 = r1 / corr;
      const halfLen = r1_20 / ohmPerM;

      r2Out.textContent = r2.toFixed(2) + ' Ω';
      r1r2Out.textContent = r1r2.toFixed(2) + ' Ω';
      lenOut.textContent = Math.round(halfLen) + ' m';

      store('ring.lineCSA', L);
      store('ring.cpcCSA', E);
      store('ring.temp', T);
    }

    lineCSA.value = load('ring.lineCSA', '2.5');
    cpcCSA.value  = load('ring.cpcCSA',  '1.0');
    temp.value    = load('ring.temp', 30);
    setR1(load('ring.r1', 0));
    lineCSA.addEventListener('change', updateRing);
    cpcCSA.addEventListener('change', updateRing);
    temp.addEventListener('input', updateRing);

    const defaultZs = {
      "B": {"6":5.83, "10":3.50, "16":2.19, "20":1.75, "25":1.40, "32":1.10, "40":0.88, "45":0.78},
      "C": {"6":2.92, "10":1.75, "16":1.10, "20":0.88, "25":0.70, "32":0.55, "40":0.44, "45":0.39},
      "D": {"6":1.46, "10":0.88, "16":0.55, "20":0.44, "25":0.35, "32":0.28, "40":0.22, "45":0.19}
    };
    const zsTable = load('zs.table', defaultZs);
    const mcbType = $('#mcbType');
    const mcbAmps = $('#mcbAmps');
    const zsResult = $('#zsResult');
    const eightyToggle = $('#eightyToggle');
    const zsJSON = $('#zsJSON');

    zsJSON.value = JSON.stringify(zsTable, null, 2);

    function updateZs(){
      const t = mcbType.value; const a = mcbAmps.value;
      const base = zsTable?.[t]?.[a];
      if(base == null){ zsResult.textContent = '-- Ω'; return; }
      const out = eightyToggle.checked ? base : (base/0.8);
      zsResult.textContent = out.toFixed(2) + ' Ω';
      store('zs.type', t); store('zs.amps', a); store('zs.80', eightyToggle.checked);
    }

    mcbType.value = load('zs.type', 'B');
    mcbAmps.value = load('zs.amps', '6');
    eightyToggle.checked = load('zs.80', true);
    mcbType.addEventListener('change', updateZs);
    mcbAmps.addEventListener('change', updateZs);
    eightyToggle.addEventListener('change', updateZs);

    $('#saveZs').addEventListener('click', ()=>{ try{ const o = JSON.parse(zsJSON.value); store('zs.table', o); location.reload(); }catch{ alert('Invalid JSON'); } });
    $('#resetZs').addEventListener('click', ()=>{ store('zs.table', defaultZs); location.reload(); });

    updateRing();
    updateZs();
  </script>
</body>
</html>
